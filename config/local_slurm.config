/* ------------------------------------------------------------------
 *  SLURM executor + global retry policy
 * ------------------------------------------------------------------ */
process {
    clusterOptions = '--ntasks=1 --nodes=1'
    errorStrategy  = 'retry'
    maxRetries     = 3
}

executor {
    name           = 'slurm'
    submitTimeout  = '3 min'
    pollInterval   = '30 sec'
    perCpuMemAllocation = false
    queueSize      = 10
}

/* ------------------------------------------------------------------
 *  Resource tiers (retry doubles time, x1.5 memory unless noted)
 * ------------------------------------------------------------------ */
process {
    withLabel: nano {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 512.MB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = {  5.m  * (task.attempt > 1 ? 1.5 : 1) }
    }
    withLabel: micro {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 10.GB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = { 30.m  * (task.attempt > 1 ? 1.5 : 1) }
    }
    withLabel: micro_long {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 10.GB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = { 1.5.h  * (task.attempt > 1 ? 1.5 : 1) }
    }
    withLabel: small {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 20.GB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = { 2.h  * (task.attempt > 1 ? 1.5 : 1) }
    }
    withLabel: snp_ignore {
        cpus         = 20
        errorStrategy = 'ignore'
        memory        = 20.GB 
        time          = 2.h
    }
    withLabel: medium {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 24.GB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = { 6.h  * (task.attempt > 1 ? 1.5 : 1) }
    }
    withLabel: large_short {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 50.GB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = { 2.h  * (task.attempt > 1 ? 1.5 : 1) }
    }
    withLabel: large {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 32.GB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = { 24.h  * (task.attempt > 1 ? 1.5 : 1) }
    }
    withLabel: xlarge {
        cpus         = 20
        errorStrategy = { task.exitStatus in 137..140 ? 'retry' : 'terminate' }
        maxRetries    = 1
        memory        = { 256.GB  * (task.attempt > 1 ? 1.5 : 1) }
        time          = { 1.5.h  * (task.attempt > 1 ? 1.5 : 1) }
    }

}
